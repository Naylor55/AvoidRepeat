## AvoidRepeat

防止接口重复提交

## 幂等性

    多个相同的操作对系统数据和状态产生的影响是一致的，称之为幂等性。

    落到基于Web的系统来说，通常指多次对RESTFul接口发起同一个请求, 必须保证操作只能成功执行一次。
    


比如:
- 订单接口, 不能多次创建订单。
- 支付接口, 重复支付同一笔订单只能扣一次钱。
- 支付宝回调接口, 可能会多次回调, 必须处理重复回调，类似的还有mq消费消息。
- 普通表单提交接口, 因为网络超时等原因多次点击提交, 只能成功一次。
- 使用浏览器回退，在历史页面中继续操作。
- 等等

实现幂等：

> 系统性的解决方案需要前端，后端，中间件，数据库等多层配合处理

- 数据库唯一索引 

- token机制，防止重复提交

- 数据库悲观锁，获取数据的时候加锁

- 数据库乐观锁，基于版本号version实现, 在更新数据那一刻校验数据

- 分布式锁，redis(jedis、redisson)或zookeeper实现

- 状态机，状态变更, 更新数据时判断状态


## 接口防止重复请求

防止接口的重复请求，可以有效的解决系统幂等性问题。同时，减少了业务系统正常运行所需要的硬件算力和资源；提升系统的健壮性和稳定性。

### 如何识别请求是否是同一个
RESTFul类型的web系统，一个接口对应某种资源，根据请求参数的不同<b>大致</b>可以判断是否请求的是某种资源中的特定内容，所以根据接口名称加该接口请求参数<b>大致</b>可以判断请求是否是同一个。


### 如何防止重复请求
思路就是在处理请求方在调用提供方的接口申请资源之前，判断该请求是否是重复的，若是重复的，不做处理，直接响应一个错误的提示。

1. 运用aop切面编程思想，在请求到达接口前获取接口名称和请求参数，将二者序列化之后得到一个特定的 token 。
2. 根据 token 去 Redis 中查询，看是否可以查询到结果。
3. 若没有查询到结果，说明请求是一个正常的请求。将token存到 Redis ，key 和 value 均为token，指定过期时间为 1s （1s仅用于演示，过期时间需要根据特定的业务场景设置）。
4. 若查询到了结果，说明是一个重复的请求，抛一个自定义的接口重复请求的异常，由全局异常捕获工具捕捉到异常之后，编排响应信息并返回给请求者。


##  工程概览

### Redis集成和配置

### Aop编写

### 自定义接口重复异常

### 测试